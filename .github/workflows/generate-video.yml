name: Generate Video

on:
    workflow_dispatch:

jobs:
    generate-video:
        runs-on: ubuntu-latest

        timeout-minutes: 10

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.9"

            - name: Enable Yarn
              run: corepack enable

            - name: Get Yarn cache directory
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.yarn-cache-dir-path.outputs.dir }}
                      node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Setup Java (required for Android SDK)
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Install Android SDK components
              run: |
                  # Accept licenses
                  yes | sdkmanager --licenses || true

                  # Install required SDK components for x86_64 emulation
                  sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
                  sdkmanager "system-images;android-33;google_apis;x86_64"
                  sdkmanager "emulator"
                  sdkmanager "cmdline-tools;latest"

            - name: Extract XAPK to split APKs
              run: |
                  # Extract XAPK (it's a ZIP file)
                  if [ -f "UBox.xapk" ]; then
                    echo "Extracting UBox.xapk..."
                    mkdir -p split-apks obb
                    unzip -q UBox.xapk -d extracted_xapk
                    
                    # Move APK files to split-apks directory
                    find extracted_xapk -name "*.apk" -exec mv {} split-apks/ \;
                    
                    # Move OBB files if they exist
                    if find extracted_xapk -name "*.obb" -type f | grep -q .; then
                      echo "OBB files found, extracting..."
                      find extracted_xapk -name "*.obb" -exec mv {} obb/ \;
                    fi
                    
                    # Cleanup
                    rm -rf extracted_xapk
                    echo "✅ XAPK extraction complete"
                  else
                    echo "⚠️ UBox.xapk not found, assuming split-apks already exist"
                  fi

            - name: Enable KVM (for faster emulation)
              run: |
                  echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                  sudo udevadm control --reload-rules
                  sudo udevadm trigger --name-match=kvm

            - name: AVD cache
              uses: actions/cache@v4
              id: avd-cache
              with:
                  path: |
                      ~/.android/avd/*
                      ~/.android/adb*
                  key: avd-33-x86_64-google_apis

            - name: Create AVD if not cached
              if: steps.avd-cache.outputs.cache-hit != 'true'
              run: |
                  echo "no" | avdmanager create avd \
                    -n test_emulator \
                    -k "system-images;android-33;google_apis;x86_64" \
                    -d pixel_5 \
                    --force

            - name: Install Appium driver
              run: |
                  yarn appium:install-driver
                  yarn appium:list-drivers

            - name: Create .env file from secrets
              run: |
                  cat > .env << EOF
                  # Cloudflare R2 Configuration
                  R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
                  R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}

                  # UBox Credentials
                  UBOX_EMAIL=${{ secrets.UBOX_EMAIL }}
                  UBOX_PASSWORD=${{ secrets.UBOX_PASSWORD }}

                  # CI Environment
                  CI=true
                  EOF

            - name: Run video generation
              run: yarn start
              env:
                  ANDROID_HOME: /usr/local/lib/android/sdk
                  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

            - name: Cleanup
              if: always()
              run: |
                  # Kill any lingering processes
                  pkill -f emulator || true
                  pkill -f appium || true
                  adb kill-server || true
