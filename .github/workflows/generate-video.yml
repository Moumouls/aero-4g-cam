name: Generate Video

on:
    workflow_dispatch:

jobs:
    generate-video:
        runs-on: ubuntu-24.04-arm

        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.9"

            - name: Enable Yarn
              run: corepack enable

            - name: Get Yarn cache directory
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.yarn-cache-dir-path.outputs.dir }}
                      node_modules
                  key: ${{ runner.os }}-arm-yarn-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-arm-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Extract XAPK to split APKs
              run: |
                  # Extract XAPK (it's a ZIP file)
                  if [ -f "UBox.xapk" ]; then
                    echo "Extracting UBox.xapk..."
                    mkdir -p split-apks obb
                    unzip -q UBox.xapk -d extracted_xapk
                    
                    # Move APK files to split-apks directory
                    find extracted_xapk -name "*.apk" -exec mv {} split-apks/ \;
                    
                    # Move OBB files if they exist
                    if find extracted_xapk -name "*.obb" -type f | grep -q .; then
                      echo "OBB files found, extracting..."
                      find extracted_xapk -name "*.obb" -exec mv {} obb/ \;
                    fi
                    
                    # Cleanup
                    rm -rf extracted_xapk
                    echo "âœ… XAPK extraction complete"
                  else
                    echo "âš ï¸ UBox.xapk not found, assuming split-apks already exist"
                  fi

            - name: Create .env file from secrets
              run: |
                  cat > .env << EOF
                  # Cloudflare R2 Configuration
                  R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
                  R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}

                  # UBox Credentials
                  UBOX_EMAIL=${{ secrets.UBOX_EMAIL }}
                  UBOX_PASSWORD=${{ secrets.UBOX_PASSWORD }}

                  # CI Environment
                  CI=true
                  EOF

            - name: Install Waydroid and ADB
              run: |
                  echo "ðŸ“¦ Installing Waydroid and ADB..."

                  # Add Waydroid repository
                  curl -s https://repo.waydro.id | sudo bash

                  # Install Waydroid and ADB tools
                  sudo apt update
                  sudo apt install -y waydroid android-tools-adb

                  # Verify installation
                  waydroid --version
                  adb --version

                  echo "âœ… Waydroid and ADB installed"

            - name: Initialize and start Waydroid
              run: |
                  echo "ðŸš€ Initializing Waydroid..."

                  # Initialize with GApps (Google Play Services)
                  sudo waydroid init -s GAPPS -f

                  # Start Waydroid container service
                  sudo systemctl start waydroid-container

                  # Wait for container to be ready
                  sleep 10

                  # Start Waydroid session in background
                  waydroid session start &
                  WAYDROID_PID=$!
                  echo $WAYDROID_PID > /tmp/waydroid.pid

                  # Wait for Android to boot completely
                  echo "â³ Waiting for Android to boot..."
                  for i in {1..60}; do
                      if waydroid status | grep -q "RUNNING"; then
                          echo "âœ… Waydroid is running"
                          break
                      fi
                      if [ $i -eq 60 ]; then
                          echo "âŒ Waydroid failed to start"
                          waydroid status
                          waydroid logcat
                          exit 1
                      fi
                      sleep 2
                  done

                  # Start UI in background (headless mode)
                  waydroid show-full-ui &
                  sleep 5

                  # Connect ADB to Waydroid
                  echo "ðŸ”Œ Connecting ADB to Waydroid..."
                  WAYDROID_IP=$(waydroid shell ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
                  echo "Waydroid IP: $WAYDROID_IP"
                  adb connect $WAYDROID_IP:5555

                  # Wait for device to be ready
                  adb wait-for-device
                  echo "âœ… ADB connected to Waydroid"

                  # Display device information
                  echo "ðŸ“± Device info:"
                  adb devices -l
                  adb shell getprop ro.build.version.release
                  adb shell getprop ro.product.model
                  adb shell getprop ro.product.cpu.abilist

                  echo "âœ… Waydroid is ready for automation"

            - name: Run automation with Appium
              run: |
                  echo "ðŸ“± Starting automation..."

                  # Verify ADB connection
                  echo "ðŸ“± ADB devices:"
                  adb devices -l

                  # Start Appium server in background
                  echo "ðŸ“± Starting Appium server..."
                  yarn exec appium --allow-cors > /tmp/appium.log 2>&1 & echo $! > /tmp/appium.pid
                  echo "Appium PID: $(cat /tmp/appium.pid)"

                  # Wait for Appium to be ready
                  echo "â³ Waiting for Appium to start..."
                  for i in {1..30}; do
                      if curl -s http://localhost:4723/status > /dev/null 2>&1; then
                          echo "âœ… Appium is ready"
                          break
                      fi
                      if [ $i -eq 30 ]; then
                          echo "âŒ Appium failed to start"
                          cat /tmp/appium.log
                          kill $(cat /tmp/appium.pid) 2>/dev/null || true
                          exit 1
                      fi
                      sleep 1
                  done

                  # Install APKs
                  echo "ðŸ“¦ Installing application..."
                  chmod +x scripts/install-app.sh
                  ./scripts/install-app.sh

                  # Run the camera recorder automation
                  echo "ðŸŽ¥ Running camera recorder automation..."
                  VERBOSE=1 node src/automation/camera-recorder.js

                  echo "âœ… Automation completed successfully"

            - name: Cleanup
              if: always()
              run: |
                  echo "ðŸ§¹ Cleaning up..."

                  # Stop Appium
                  if [ -f /tmp/appium.pid ]; then
                      kill $(cat /tmp/appium.pid) 2>/dev/null || true
                  fi
                  pkill -f appium || true

                  # Show Appium logs
                  if [ -f /tmp/appium.log ]; then
                      echo "ðŸ“‹ Appium logs (last 50 lines):"
                      tail -50 /tmp/appium.log
                  fi

                  # Stop Waydroid
                  if [ -f /tmp/waydroid.pid ]; then
                      kill $(cat /tmp/waydroid.pid) 2>/dev/null || true
                  fi
                  waydroid session stop || true
                  sudo systemctl stop waydroid-container || true

                  echo "âœ… Cleanup completed"
