name: Generate Video

on:
    workflow_dispatch:

jobs:
    generate-video:
        runs-on: ubuntu-latest

        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.9"

            - name: Enable Yarn
              run: corepack enable

            - name: Get Yarn cache directory
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.yarn-cache-dir-path.outputs.dir }}
                      node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Extract XAPK to split APKs
              run: |
                  # Extract XAPK (it's a ZIP file)
                  if [ -f "UBox.xapk" ]; then
                    echo "Extracting UBox.xapk..."
                    mkdir -p split-apks obb
                    unzip -q UBox.xapk -d extracted_xapk
                    
                    # Move APK files to split-apks directory
                    find extracted_xapk -name "*.apk" -exec mv {} split-apks/ \;
                    
                    # Move OBB files if they exist
                    if find extracted_xapk -name "*.obb" -type f | grep -q .; then
                      echo "OBB files found, extracting..."
                      find extracted_xapk -name "*.obb" -exec mv {} obb/ \;
                    fi
                    
                    # Cleanup
                    rm -rf extracted_xapk
                    echo "âœ… XAPK extraction complete"
                  else
                    echo "âš ï¸ UBox.xapk not found, assuming split-apks already exist"
                  fi

            - name: Create .env file from secrets
              run: |
                  cat > .env << EOF
                  # Cloudflare R2 Configuration
                  R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
                  R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}

                  # UBox Credentials
                  UBOX_EMAIL=${{ secrets.UBOX_EMAIL }}
                  UBOX_PASSWORD=${{ secrets.UBOX_PASSWORD }}

                  # CI Environment
                  CI=true
                  EOF

            - name: Enable KVM for Linux
              run: |
                  echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                  sudo udevadm control --reload-rules
                  sudo udevadm trigger --name-match=kvm
                  # Verify KVM is accessible
                  ls -la /dev/kvm

            - name: Run Android Emulator with ARM translation
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: 35
                  target: google_apis
                  arch: x86_64
                  profile: pixel_5
                  force-avd-creation: false
                  emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
                  disable-animations: true
                  script: |
                      echo "ðŸ“± Emulator is ready!"

                      # Show device info
                      echo "ðŸ“± Device info:"
                      adb shell getprop ro.build.version.release
                      adb shell getprop ro.product.model
                      adb devices -l

                      # Verify ARM translation support
                      echo "ðŸ” Checking ARM ABI support on emulator..."
                      adb shell getprop ro.product.cpu.abilist | tee /tmp/abi_list.txt || echo "unknown" > /tmp/abi_list.txt
                      echo "Supported ABIs: $(cat /tmp/abi_list.txt)"
                      if grep -q "arm64-v8a" /tmp/abi_list.txt; then echo "âœ… arm64-v8a is supported"; else echo "âš ï¸ arm64-v8a is NOT supported - ARM APK installation may fail"; fi

                      adb shell getprop ro.dalvik.vm.native.bridge | tee /tmp/native_bridge.txt || echo "none" > /tmp/native_bridge.txt
                      echo "Native bridge: $(cat /tmp/native_bridge.txt)"
                      if grep -q "libndk" /tmp/native_bridge.txt; then echo "âœ… ARM translation (libndk_translation) is active"; else echo "âš ï¸ ARM translation bridge: $(cat /tmp/native_bridge.txt)"; fi

                      # Start Appium server in background
                      echo "ðŸ“± Starting Appium server..."
                      yarn exec appium --allow-cors > /tmp/appium.log 2>&1 & echo $! > /tmp/appium.pid
                      echo "Appium PID: $(cat /tmp/appium.pid)"

                      # Wait for Appium to be ready
                      echo "â³ Waiting for Appium to start..."
                      for i in {1..30}; do
                          if curl -s http://localhost:4723/status > /dev/null 2>&1; then
                              echo "âœ… Appium is ready"
                              break
                          fi
                          if [ $i -eq 30 ]; then
                              echo "âŒ Appium failed to start"
                              cat /tmp/appium.log
                              kill $(cat /tmp/appium.pid) 2>/dev/null || true
                              exit 1
                          fi
                          sleep 1
                      done

                      # Install APKs and run automation
                      echo "ðŸ“¦ Installing application..."
                      chmod +x scripts/install-app.sh
                      ./scripts/install-app.sh

                      # Run the camera recorder automation
                      echo "ðŸŽ¥ Running camera recorder automation..."
                      VERBOSE=1 node src/automation/camera-recorder.js

                      # Cleanup Appium
                      echo "ðŸ§¹ Stopping Appium..."
                      kill $(cat /tmp/appium.pid 2>/dev/null) 2>/dev/null || true
                      pkill -f appium || true

                      # Show logs
                      if [ -f /tmp/appium.log ]; then
                          echo "ðŸ“‹ Appium logs (last 50 lines):"
                          tail -50 /tmp/appium.log
                      fi

                      echo "âœ… Automation completed successfully"
