name: Generate Video

on:
    workflow_dispatch:

jobs:
    generate-video:
        runs-on: ubuntu-latest

        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.9"

            - name: Enable Yarn
              run: corepack enable

            - name: Get Yarn cache directory
              id: yarn-cache-dir-path
              run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

            - name: Cache Yarn dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.yarn-cache-dir-path.outputs.dir }}
                      node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - name: Install dependencies
              run: yarn install --immutable

            - name: Extract XAPK to split APKs
              run: |
                  # Extract XAPK (it's a ZIP file)
                  if [ -f "UBox.xapk" ]; then
                    echo "Extracting UBox.xapk..."
                    mkdir -p split-apks obb
                    unzip -q UBox.xapk -d extracted_xapk
                    
                    # Move APK files to split-apks directory
                    find extracted_xapk -name "*.apk" -exec mv {} split-apks/ \;
                    
                    # Move OBB files if they exist
                    if find extracted_xapk -name "*.obb" -type f | grep -q .; then
                      echo "OBB files found, extracting..."
                      find extracted_xapk -name "*.obb" -exec mv {} obb/ \;
                    fi
                    
                    # Cleanup
                    rm -rf extracted_xapk
                    echo "âœ… XAPK extraction complete"
                  else
                    echo "âš ï¸ UBox.xapk not found, assuming split-apks already exist"
                  fi
            - name: Create .env file from secrets
              run: |
                  cat > .env << EOF
                  # Cloudflare R2 Configuration
                  R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
                  R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}

                  # UBox Credentials
                  UBOX_EMAIL=${{ secrets.UBOX_EMAIL }}
                  UBOX_PASSWORD=${{ secrets.UBOX_PASSWORD }}

                  # CI Environment
                  CI=true
                  EOF

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Setup Android SDK manually
              run: |
                  echo "ðŸ“¦ Installing Android SDK for x86_64 Linux..."

                  # Set Android SDK path
                  export ANDROID_HOME=$HOME/android-sdk
                  mkdir -p $ANDROID_HOME

                  # Download command line tools for Linux
                  cd $HOME
                  wget -q https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip -O cmdline-tools.zip
                  unzip -q cmdline-tools.zip

                  # Set up proper directory structure
                  mkdir -p $ANDROID_HOME/cmdline-tools
                  mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
                  rm cmdline-tools.zip

                  # Set up PATH
                  echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
                  echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
                  echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
                  echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
                  echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV

                  # Verify installation
                  ls -la $ANDROID_HOME/cmdline-tools/latest/bin/

                  echo "âœ… Android SDK tools installed"

            - name: Cache Android SDK
              uses: actions/cache@v4
              id: android-cache
              with:
                  path: |
                      ~/android-sdk
                      ~/.android/avd
                  key: ${{ runner.os }}-${{ runner.arch }}-android-sdk-api33-x86_64-playstore-v1-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ runner.arch }}-android-sdk-api33-x86_64-playstore-v1-
                      ${{ runner.os }}-${{ runner.arch }}-android-sdk-

            - name: Install Android SDK components
              if: steps.android-cache.outputs.cache-hit != 'true'
              run: |
                  echo "ðŸ“¦ Installing Android SDK components (this may take 5-10 minutes on first run)..."
                  echo "â° Started at: $(date)"

                  # Accept licenses and install components in one go
                  echo "Installing SDK platforms and tools..."
                  yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install \
                      "platforms;android-33" \
                      "platform-tools" \
                      "emulator" \
                      "build-tools;33.0.0" || true

                  echo "Installing system image with Play Store and ARM translation (largest download ~800MB)..."
                  yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install \
                      "system-images;android-33;google_apis_playstore;x86_64" || true

                  echo "âœ… SDK components installed at: $(date)"

            - name: Verify SDK installation
              run: |
                  if [ "${{ steps.android-cache.outputs.cache-hit }}" == "true" ]; then
                      echo "âœ… Using cached Android SDK components"
                  fi

                  echo "ðŸ“‹ Installed SDK packages:"
                  $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed

                  echo ""
                  echo "ðŸ“‹ Verifying critical components:"
                  ls -la $ANDROID_HOME/platform-tools/adb || echo "âš ï¸ adb not found"
                  ls -la $ANDROID_HOME/emulator/emulator || echo "âš ï¸ emulator not found"

            - name: Enable KVM
              run: |
                  echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                  sudo udevadm control --reload-rules
                  sudo udevadm trigger --name-match=kvm
                  # Verify KVM is accessible
                  ls -la /dev/kvm

            - name: Clean up old AVDs
              run: |
                  # Remove old ARM64 AVD if it exists (from previous cache)
                  if [ -d ~/.android/avd/test_avd.avd ]; then
                      echo "ðŸ§¹ Removing old ARM64 AVD..."
                      rm -rf ~/.android/avd/test_avd.avd
                      rm -f ~/.android/avd/test_avd.ini
                      echo "âœ… Old AVD removed"
                  fi

            - name: Create AVD
              run: |
                  AVD_NAME="test_avd_x86_64"
                  if [ -d ~/.android/avd/${AVD_NAME}.avd ]; then
                      echo "âœ… Using cached AVD: ${AVD_NAME}"
                  else
                      echo "ðŸ“± Creating AVD (x86_64 with Google Play and ARM translation)..."
                      echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
                          --force \
                          --name ${AVD_NAME} \
                          --package "system-images;android-33;google_apis_playstore;x86_64" \
                          --device "pixel_5"
                      echo "âœ… AVD created: ${AVD_NAME}"
                  fi

                  # Export AVD name for next steps
                  echo "AVD_NAME=${AVD_NAME}" >> $GITHUB_ENV

            - name: Start Android Emulator
              run: |
                  AVD_NAME="test_avd_x86_64"
                  echo "ðŸš€ Starting Android Emulator (x86_64 with ARM translation and KVM acceleration)..."
                  echo "Using AVD: ${AVD_NAME}"

                  # List available AVDs for debugging
                  echo "ðŸ“‹ Available AVDs:"
                  $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

                  # Verify KVM is available
                  if [ -e /dev/kvm ]; then
                      echo "âœ… KVM is available"
                      ls -la /dev/kvm
                  else
                      echo "âš ï¸ KVM not available, emulator will be slow"
                  fi

                  # Verify AVD exists
                  if [ ! -d ~/.android/avd/${AVD_NAME}.avd ]; then
                      echo "âŒ AVD not found: ${AVD_NAME}"
                      echo "Creating AVD now..."
                      echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
                          --force \
                          --name ${AVD_NAME} \
                          --package "system-images;android-33;google_apis_playstore;x86_64" \
                          --device "pixel_5"
                  fi

                  # Start emulator with KVM
                  $ANDROID_HOME/emulator/emulator \
                      -avd ${AVD_NAME} \
                      -no-snapshot-save \
                      -no-window \
                      -gpu swiftshader_indirect \
                      -noaudio \
                      -no-boot-anim \
                      -camera-back none \
                      -camera-front none \
                      -memory 2048 \
                      -accel on \
                      > /tmp/emulator.log 2>&1 &

                  echo $! > /tmp/emulator.pid
                  echo "âœ… Emulator started with PID $(cat /tmp/emulator.pid)"

            - name: Wait for Emulator to boot
              run: |
                  echo "â³ Waiting for emulator to boot..."

                  # Show emulator log in background for debugging
                  tail -f /tmp/emulator.log &
                  TAIL_PID=$!

                  $ANDROID_HOME/platform-tools/adb wait-for-device
                  echo "ðŸ“± Device detected by ADB"

                  # Wait for boot to complete (should be fast with KVM!)
                  boot_completed=false
                  for i in {1..90}; do
                      if $ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                          boot_completed=true
                          echo "âœ… Emulator booted successfully in $((i * 2)) seconds"
                          break
                      fi
                      if [ $((i % 15)) -eq 0 ]; then
                          echo "â³ Still waiting for boot... ($((i * 2))s elapsed)"
                      fi
                      sleep 2
                  done

                  # Stop tailing the log
                  kill $TAIL_PID 2>/dev/null || true

                  if [ "$boot_completed" = false ]; then
                      echo "âŒ Emulator failed to boot within 3 minutes"
                      echo "ðŸ“‹ Last 100 lines of emulator log:"
                      tail -100 /tmp/emulator.log
                      exit 1
                  fi

                  # Disable animations
                  $ANDROID_HOME/platform-tools/adb shell settings put global window_animation_scale 0
                  $ANDROID_HOME/platform-tools/adb shell settings put global transition_animation_scale 0
                  $ANDROID_HOME/platform-tools/adb shell settings put global animator_duration_scale 0

                  # Show device info
                  echo "ðŸ“± Device info:"
                  $ANDROID_HOME/platform-tools/adb shell getprop ro.build.version.release
                  $ANDROID_HOME/platform-tools/adb shell getprop ro.product.model
                  $ANDROID_HOME/platform-tools/adb devices -l

            - name: Install Appium UiAutomator2 driver
              run: |
                  echo "ðŸ“± Checking Appium drivers..."
                  if yarn exec appium driver list --installed 2>/dev/null | grep -q "uiautomator2"; then
                      echo "âœ… UiAutomator2 driver already installed"
                  else
                      echo "ðŸ“¦ Installing UiAutomator2 driver..."
                      yarn exec appium driver install uiautomator2
                      echo "âœ… UiAutomator2 driver installed"
                  fi
                  yarn exec appium driver list --installed

            - name: Verify ARM translation support
              run: |
                  echo "ðŸ” Checking ARM ABI support on emulator..."

                  ABI_LIST=$($ANDROID_HOME/platform-tools/adb shell getprop ro.product.cpu.abilist)
                  echo "Supported ABIs: $ABI_LIST"

                  if echo "$ABI_LIST" | grep -q "arm64-v8a"; then
                      echo "âœ… arm64-v8a is supported"
                  else
                      echo "âŒ arm64-v8a is NOT supported - ARM APK installation may fail"
                      exit 1
                  fi

                  NATIVE_BRIDGE=$($ANDROID_HOME/platform-tools/adb shell getprop ro.dalvik.vm.native.bridge)
                  echo "Native bridge: $NATIVE_BRIDGE"

                  if echo "$NATIVE_BRIDGE" | grep -q "libndk"; then
                      echo "âœ… ARM translation (libndk_translation) is active"
                  else
                      echo "âš ï¸ ARM translation may be using different bridge: $NATIVE_BRIDGE"
                  fi

            - name: Start Appium server
              run: |
                  echo "ðŸ“± Starting Appium server..."
                  yarn exec appium --allow-cors > /tmp/appium.log 2>&1 &
                  echo $! > /tmp/appium.pid

                  # Wait for Appium to be ready
                  echo "Waiting for Appium to start..."
                  for i in {1..30}; do
                      if curl -s http://localhost:4723/status > /dev/null 2>&1; then
                          echo "âœ… Appium is ready"
                          break
                      fi
                      if [ $i -eq 30 ]; then
                          echo "âŒ Appium failed to start"
                          cat /tmp/appium.log
                          exit 1
                      fi
                      sleep 1
                  done

            - name: Run Automation
              run: |
                  # Make script executable
                  chmod +x scripts/install-app.sh

                  # Install APKs and prepare device
                  ./scripts/install-app.sh

                  # Run the camera recorder automation
                  VERBOSE=1 node src/automation/camera-recorder.js

            - name: Cleanup
              if: always()
              run: |
                  # Kill Appium server
                  if [ -f /tmp/appium.pid ]; then
                      kill $(cat /tmp/appium.pid) 2>/dev/null || true
                  fi
                  pkill -f appium || true

                  # Kill emulator
                  if [ -f /tmp/emulator.pid ]; then
                      kill $(cat /tmp/emulator.pid) 2>/dev/null || true
                  fi
                  $ANDROID_HOME/platform-tools/adb emu kill 2>/dev/null || true

                  # Show logs if they exist
                  if [ -f /tmp/appium.log ]; then
                      echo "ðŸ“‹ Appium logs:"
                      tail -100 /tmp/appium.log
                  fi

                  if [ -f /tmp/emulator.log ]; then
                      echo "ðŸ“‹ Emulator logs:"
                      tail -100 /tmp/emulator.log
                  fi
