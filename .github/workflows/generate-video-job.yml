name: Generate Video Job (Reusable)

on:
  workflow_call:
    secrets:
      R2_ACCOUNT_ID:
        required: true
      R2_ACCESS_KEY_ID:
        required: true
      R2_SECRET_ACCESS_KEY:
        required: true
      R2_BUCKET_NAME:
        required: true
      R2_ENDPOINT:
        required: true
      UBOX_EMAIL:
        required: true
      UBOX_PASSWORD:
        required: true

jobs:
  run-video-generation:
    runs-on: ubuntu-latest

    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache UBox.xapk
        id: cache-ubox
        uses: actions/cache@v4
        with:
          path: UBox.xapk
          key: ubox-xapk-${{ hashFiles('UBox.xapk') }}
          restore-keys: |
            ubox-xapk-

      - name: Download UBox.xapk
        if: steps.cache-ubox.outputs.cache-hit != 'true'
        run: |
          curl -L -o UBox.xapk https://pub-51ba0aed33f74669a4a1cb1095e33dfb.r2.dev/UBox.xapk

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.9"

      - name: Enable Yarn
        run: corepack enable

      - name: Get Yarn cache directory
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Extract XAPK to split APKs
        run: |
          # Extract XAPK (it's a ZIP file)
          if [ -f "UBox.xapk" ]; then
            echo "Extracting UBox.xapk..."
            mkdir -p split-apks obb
            unzip -q UBox.xapk -d extracted_xapk
            
            # Move APK files to split-apks directory
            find extracted_xapk -name "*.apk" -exec mv {} split-apks/ \;
            
            # Move OBB files if they exist
            if find extracted_xapk -name "*.obb" -type f | grep -q .; then
              echo "OBB files found, extracting..."
              find extracted_xapk -name "*.obb" -exec mv {} obb/ \;
            fi
            
            # Cleanup
            rm -rf extracted_xapk
            echo "✅ XAPK extraction complete"
          else
            echo "⚠️ UBox.xapk not found, assuming split-apks already exist"
          fi

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          # Cloudflare R2 Configuration
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}

          # UBox Credentials
          UBOX_EMAIL=${{ secrets.UBOX_EMAIL }}
          UBOX_PASSWORD=${{ secrets.UBOX_PASSWORD }}

          # CI Environment
          CI=true
          EOF

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Android Emulator with ARM translation
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 35
          target: google_apis
          arch: x86_64
          profile: pixel_5
          ram-size: 4096
          script: bash scripts/run-automation.sh

      # - name: Upload screenshots
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: screenshots
      #     path: screenshots
      #     if-no-files-found: ignore
